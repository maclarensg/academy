---
# bootstrap salt master

- name: Check if salt already exist
  stat:
    path: /usr/bin/salt
  register: r_salt

- name: Check Bootsrap salt script exist
  stat:
    path: /tmp/bootstrap-salt.sh
  register: r_bootstrap_downloaded
  when: r_salt.stat.exists == False

- name: Download Boostrap salt script from saltstack.com
  get_url:
    url: http://bootstrap.saltstack.com
    dest: /tmp/bootstrap-salt.sh
    mode: '0755'
  when: 
    - r_salt.stat.exists == False
    - r_bootstrap_downloaded.stat.exists == False
    
- name: Run/Install Boostrap salt script Master
  command:
    cmd: /tmp/bootstrap-salt.sh -P -M
  when: 
   - r_salt.stat.exists == False
   - "'tag_role_salt-master' in group_names"

- name: Run/Install Boostrap salt script Minion
  command:
    cmd: /tmp/bootstrap-salt.sh -P 
  when: 
   - r_salt.stat.exists == False
   - "'tag_role_salt-minion' in group_names"

- name: ensure host file has salt ipv4
  lineinfile:
    path: /etc/hosts
    regexp: '^(127\.0\.0\.1.*)$'
    state: present
    backrefs: yes
    line: '\1 salt'
  when: "'tag_role_salt-master' in group_names"

- name: ensure host file has salt ipv6
  lineinfile:
    path: /etc/hosts
    regexp: '^(\:\:1.*)$'
    state: present
    backrefs: yes
    line: '\1 salt'
  when: "'tag_role_salt-master' in group_names"

- name: ensure host file has salt ipv6
  lineinfile:
    path: /etc/hosts
    regexp: "{{hostvars[groups['tag_role_salt-master'][0]].ansible_facts.default_ipv4.address}} salt"
    state: present
    line: "{{hostvars[groups['tag_role_salt-master'][0]].ansible_facts.default_ipv4.address}} salt"
  when: "'tag_role_salt-minion' in group_names"